<!DOCTYPE html>
<html>
<head>
<title>How to use epoll? A complete example in C - Banu Blog</title>
<link rel="shortcut icon" type="image/png" media="screen" href="/static/0.9.53/images/favicon.png" />
<link rel="stylesheet" type="text/css" media="screen" href="/static/0.9.53/css/banu.css" />
<link rel="alternate" type="application/rss+xml" media="screen" title="Banu Blog (RSS)" href="/blog/feed/" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="banuweb version 0.9.53 (developer)" />
</head>

<body>

<div id="banu-header">
<h1><a href="/" title="Banu homepage">Banu</a></h1>
<ul>
<li><a class="tab-shop highlight-two" href="/shop/" title="An internet supermarket store in India">Banu Shop</a></li>
<li><a class="tab-projects highlight-four" href="/projects/" title="Projects at Banu">Projects</a></li>
<li><a class="tab-blog current" href="/blog/" title="Banu staff blog">Banu Blog</a></li>
</ul>
</div>

<div id="banu-page">
<div id="banu-simple-page">

<div id="banu-twocol-side">


<p><a href="/blog/">Banu Blog</a></p>

<p><strong>Follow us</strong></p>

<ul>
<li><a href="/about/">About Banu</a></li>
<li><a rel="nofollow" href="/blog/feed/">RSS feed</a></li>
<li>&#x21b3; <a rel="nofollow" href="https://www.google.com/ig/add?feedurl=https%3A%2F%2Fbanu.com%2Fblog%2Ffeed%2F">Add to Google Reader</a></li>
</ul>

<p><strong>Categories</strong></p>

<ul>
<li><a href="/blog/category/1/banu/">Banu</a></li>
<li><a href="/blog/category/2/banu-shop/">Banu Shop</a></li>
<li><a href="/blog/category/3/chess/">Chess</a></li>
<li><a href="/blog/category/4/graphics/">Graphics</a></li>
<li><a href="/blog/category/13/hardware/">Hardware</a></li>
<li><a href="/blog/category/5/linux/">Linux</a></li>
<li><a href="/blog/category/6/networks/">Networks</a></li>
<li><a href="/blog/category/7/programming/">Programming</a></li>
<li><a href="/blog/category/14/raster/">Raster</a></li>
<li><a href="/blog/category/12/security/">Security</a></li>
<li><a href="/blog/category/10/tinyproxy/">Tinyproxy</a></li>
<li><a href="/blog/category/11/unzix/">Unzix</a></li>
</ul>

<p><strong>Archive</strong></p>

<ul>
<li><a href="/blog/archive/2011/10/">October 2011</a></li>
<li><a href="/blog/archive/2011/09/">September 2011</a></li>
<li><a href="/blog/archive/2011/08/">August 2011</a></li>
<li><a href="/blog/archive/2011/06/">June 2011</a></li>
<li><a href="/blog/archive/2011/04/">April 2011</a></li>
<li><a href="/blog/archive/2011/03/">March 2011</a></li>
<li><a href="/blog/archive/2011/02/">February 2011</a></li>
<li><a href="/blog/archive/2010/10/">October 2010</a></li>
<li><a href="/blog/archive/2010/06/">June 2010</a></li>
<li><a href="/blog/archive/2009/10/">October 2009</a></li>
<li><a href="/blog/archive/2008/12/">December 2008</a></li>
<li><a href="/blog/archive/2008/09/">September 2008</a></li>
<li><a href="/blog/archive/2008/07/">July 2008</a></li>
<li><a href="/blog/archive/2008/04/">April 2008</a></li>
<li><a href="/blog/archive/2007/07/">July 2007</a></li>
<li><a href="/blog/archive/2007/04/">April 2007</a></li>
<li><a href="/blog/archive/2006/12/">December 2006</a></li>
<li><a href="/blog/archive/2006/09/">September 2006</a></li>
<li><a href="/blog/archive/2006/06/">June 2006</a></li>
</ul>


</div> <!-- banu-twocol-side -->

<div id="banu-twocol-main">

<h2><a href="/blog/2/how-to-use-epoll-a-complete-example-in-c/">How to use epoll? A complete example in C</a></h2>

<p><em>Thursday, 2 June 2011 @ 1238 GMT by Mukund Sivaraman</em></p>

<p>Network servers are traditionally implemented using a separate
process or thread per connection. For high performance applications that
need to handle a very large number of clients simultaneously, this
approach won't work well, because factors such as resource usage and
context-switching time influence the ability to handle many clients at a
time. An alternate method is to perform <a rel="nofollow"
href="http://en.wikipedia.org/wiki/Asynchronous_I/O">non-blocking
I/O</a> in a single thread, along with some readiness notification
method which tells you when you can read or write more data on a
socket.</p>

<p>This article is an introduction to Linux's <strong>epoll</strong>(7)
facility, which is the best readiness notification facility in Linux. We
will write sample code for a complete TCP server implementation in C. I
assume you have C programming experience, know how to compile and run
programs on Linux, and can read manpages of the various C functions that
are used.</p>

<p>epoll was introduced in Linux 2.6, and is not available in other
UNIX-like operating systems. It provides a facility similar to
the <strong>select</strong>(2) and <strong>poll</strong>(2)
functions:</p>

<ul>

<li><strong>select</strong>(2) can monitor up to <code>FD_SETSIZE</code>
number of descriptors at a time, typically a small number determined at
libc's compile time.</li>

<li><strong>poll</strong>(2) doesn't have a fixed limit of descriptors
it can monitor at a time, but apart from other things, even we have to
perform a linear scan of all the passed descriptors every time to check
readiness notification, which is O(n) and slow.</li>

</ul>

<p>epoll has no such fixed limits, and does not perform any linear
scans. Hence it is able to perform better and handle a larger number of
events.</p>

<p>An epoll instance is created by <strong>epoll_create</strong>(2)
or <strong>epoll_create1</strong>(2) (they take different arguments),
which return an epoll instance. <strong>epoll_ctl</strong>(2) is used to
add/remove descriptors to be watched on the epoll instance. To wait for
events on the watched set, <strong>epoll_wait</strong>(2) is used, which
blocks until events are available. Please see their manpages for more
info.</p>

<p>When descriptors are added to an epoll instance, they can be added in
two modes: <strong>level triggered</strong> and <strong>edge
triggered.</strong> When you use level triggered mode, and data is
available for reading, <strong>epoll_wait</strong>(2) will always return
with ready events. If you don't read the data completely, and
call <strong>epoll_wait</strong>(2) on the epoll instance watching the
descriptor again, it will return again with a ready event because data
is available. In edge triggered mode, you will only get a readiness
notfication once. If you don't read the data fully, and
call <strong>epoll_wait</strong>(2) on the epoll instance watching the
descriptor again, it will block because the readiness event was already
delivered.</p>

<p>The epoll event structure that you pass
to <strong>epoll_ctl</strong>(2) is shown below.  With every descriptor
being watched, you can associate an integer or a pointer as user
data.</p>

<pre><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">union</span></span> epoll_data
<span style="color: #FF0000">{</span>
  <span style="color: #009900">void</span>        <span style="color: #990000">*</span>ptr<span style="color: #990000">;</span>
  <span style="color: #009900">int</span>          fd<span style="color: #990000">;</span>
  __<span style="color: #008080">uint32_t</span>   u32<span style="color: #990000">;</span>
  __<span style="color: #008080">uint64_t</span>   u64<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span> epoll_data_t<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">epoll_event</span>
<span style="color: #FF0000">{</span>
  __<span style="color: #008080">uint32_t</span>   events<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* Epoll events */</span></span>
  <span style="color: #008080">epoll_data_t</span> data<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">/* User data variable */</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
</pre>

<p>Let's write code now. We'll implement a tiny TCP server that prints
everything sent to the socket on standard output. We'll begin by writing
a function <strong>create_and_bind</strong>() which creates and binds a
TCP socket:</p>

<pre><span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">int</span>
<span style="font-weight: bold"><span style="color: #000000">create_and_bind</span></span> <span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">*</span>port<span style="color: #990000">)</span>
<span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">addrinfo</span> hints<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">addrinfo</span> <span style="color: #990000">*</span>result<span style="color: #990000">,</span> <span style="color: #990000">*</span>rp<span style="color: #990000">;</span>
  <span style="color: #009900">int</span> s<span style="color: #990000">,</span> sfd<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">memset</span></span> <span style="color: #990000">(&amp;</span>hints<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">addrinfo</span><span style="color: #990000">));</span>
  hints<span style="color: #990000">.</span>ai_family <span style="color: #990000">=</span> AF_UNSPEC<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* Return IPv4 and IPv6 choices */</span></span>
  hints<span style="color: #990000">.</span>ai_socktype <span style="color: #990000">=</span> SOCK_STREAM<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* We want a TCP socket */</span></span>
  hints<span style="color: #990000">.</span>ai_flags <span style="color: #990000">=</span> AI_PASSIVE<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* All interfaces */</span></span>

  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">getaddrinfo</span></span> <span style="color: #990000">(</span>NULL<span style="color: #990000">,</span> port<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>hints<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>result<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">!=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span> <span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"getaddrinfo: %s</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">gai_strerror</span></span> <span style="color: #990000">(</span>s<span style="color: #990000">));</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>rp <span style="color: #990000">=</span> result<span style="color: #990000">;</span> rp <span style="color: #990000">!=</span> NULL<span style="color: #990000">;</span> rp <span style="color: #990000">=</span> rp<span style="color: #990000">-&gt;</span>ai_next<span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      sfd <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">socket</span></span> <span style="color: #990000">(</span>rp<span style="color: #990000">-&gt;</span>ai_family<span style="color: #990000">,</span> rp<span style="color: #990000">-&gt;</span>ai_socktype<span style="color: #990000">,</span> rp<span style="color: #990000">-&gt;</span>ai_protocol<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sfd <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">continue</span></span><span style="color: #990000">;</span>

      s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">bind</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">,</span> rp<span style="color: #990000">-&gt;</span>ai_addr<span style="color: #990000">,</span> rp<span style="color: #990000">-&gt;</span>ai_addrlen<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
        <span style="color: #FF0000">{</span>
          <span style="font-style: italic"><span style="color: #9A1900">/* We managed to bind successfully! */</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

      <span style="font-weight: bold"><span style="color: #000000">close</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>rp <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span> <span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"Could not bind</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #000000">freeaddrinfo</span></span> <span style="color: #990000">(</span>result<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sfd<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>
</pre>


<p><strong>create_and_bind</strong>() contains a standard code block for
a portable way of getting a IPv4 or IPv6 socket. It accepts
a <code>port</code> argument as a string, where <code>argv[1]</code> can
be passed.  The <strong>getaddrinfo</strong>(3) function returns a bunch
of <code>addrinfo</code> structures in <code>result</code>, which are
compatible with the hints passed in the <code>hints</code>
argument. The <code>addrinfo</code> struct looks like this:</p>

<pre><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">addrinfo</span>
<span style="color: #FF0000">{</span>
  <span style="color: #009900">int</span>              ai_flags<span style="color: #990000">;</span>
  <span style="color: #009900">int</span>              ai_family<span style="color: #990000">;</span>
  <span style="color: #009900">int</span>              ai_socktype<span style="color: #990000">;</span>
  <span style="color: #009900">int</span>              ai_protocol<span style="color: #990000">;</span>
  <span style="color: #008080">size_t</span>           ai_addrlen<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">sockaddr</span> <span style="color: #990000">*</span>ai_addr<span style="color: #990000">;</span>
  <span style="color: #009900">char</span>            <span style="color: #990000">*</span>ai_canonname<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">addrinfo</span> <span style="color: #990000">*</span>ai_next<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
</pre>


<p>We walk through the structures one by one and try creating sockets
using them, until we are able to both create and bind a socket. If we
were successful, <strong>create_and_bind</strong>() returns the socket
descriptor. If unsuccessful, it returns -1.</p>

<p>Next, let's write a function to make a socket
non-blocking. <strong>make_socket_non_blocking</strong>() sets
the <code>O_NONBLOCK</code> flag on the descriptor passed in
the <code>sfd</code> argument:</p>

<pre><span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">int</span>
<span style="font-weight: bold"><span style="color: #000000">make_socket_non_blocking</span></span> <span style="color: #990000">(</span><span style="color: #009900">int</span> sfd<span style="color: #990000">)</span>
<span style="color: #FF0000">{</span>
  <span style="color: #009900">int</span> flags<span style="color: #990000">,</span> s<span style="color: #990000">;</span>

  flags <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fcntl</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">,</span> F_GETFL<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>flags <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"fcntl"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

  flags <span style="color: #990000">|=</span> O_NONBLOCK<span style="color: #990000">;</span>
  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fcntl</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">,</span> F_SETFL<span style="color: #990000">,</span> flags<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"fcntl"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>
</pre>


<p>Now, on to the <strong>main</strong>() function of the program which
contains the event loop. This is the bulk of the program:</p>

<pre><span style="font-weight: bold"><span style="color: #000080">#define</span></span> MAXEVENTS <span style="color: #993399">64</span>

<span style="color: #009900">int</span>
<span style="font-weight: bold"><span style="color: #000000">main</span></span> <span style="color: #990000">(</span><span style="color: #009900">int</span> argc<span style="color: #990000">,</span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>argv<span style="color: #990000">[])</span>
<span style="color: #FF0000">{</span>
  <span style="color: #009900">int</span> sfd<span style="color: #990000">,</span> s<span style="color: #990000">;</span>
  <span style="color: #009900">int</span> efd<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">epoll_event</span> event<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">epoll_event</span> <span style="color: #990000">*</span>events<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>argc <span style="color: #990000">!=</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span> <span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"Usage: %s [port]</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> argv<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]);</span>
      <span style="font-weight: bold"><span style="color: #000000">exit</span></span> <span style="color: #990000">(</span>EXIT_FAILURE<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

  sfd <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">create_and_bind</span></span> <span style="color: #990000">(</span>argv<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sfd <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>

  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">make_socket_non_blocking</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>

  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">listen</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">,</span> SOMAXCONN<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"listen"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>

  efd <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">epoll_create1</span></span> <span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>efd <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"epoll_create"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>

  event<span style="color: #990000">.</span>data<span style="color: #990000">.</span>fd <span style="color: #990000">=</span> sfd<span style="color: #990000">;</span>
  event<span style="color: #990000">.</span>events <span style="color: #990000">=</span> EPOLLIN <span style="color: #990000">|</span> EPOLLET<span style="color: #990000">;</span>
  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">epoll_ctl</span></span> <span style="color: #990000">(</span>efd<span style="color: #990000">,</span> EPOLL_CTL_ADD<span style="color: #990000">,</span> sfd<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>event<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"epoll_ctl"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">/* Buffer where events are returned */</span></span>
  events <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">calloc</span></span> <span style="color: #990000">(</span>MAXEVENTS<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span> event<span style="color: #990000">);</span>

  <span style="font-style: italic"><span style="color: #9A1900">/* The event loop */</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="color: #009900">int</span> n<span style="color: #990000">,</span> i<span style="color: #990000">;</span>

      n <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">epoll_wait</span></span> <span style="color: #990000">(</span>efd<span style="color: #990000">,</span> events<span style="color: #990000">,</span> MAXEVENTS<span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> n<span style="color: #990000">;</span> i<span style="color: #990000">++)</span>
	<span style="color: #FF0000">{</span>
	  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((</span>events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>events <span style="color: #990000">&amp;</span> EPOLLERR<span style="color: #990000">)</span> <span style="color: #990000">||</span>
              <span style="color: #990000">(</span>events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>events <span style="color: #990000">&amp;</span> EPOLLHUP<span style="color: #990000">)</span> <span style="color: #990000">||</span>
              <span style="color: #990000">(!(</span>events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>events <span style="color: #990000">&amp;</span> EPOLLIN<span style="color: #990000">)))</span>
	    <span style="color: #FF0000">{</span>
              <span style="font-style: italic"><span style="color: #9A1900">/* An error has occured on this fd, or the socket is not</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                 ready for reading (why were we notified then?) */</span></span>
	      <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span> <span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"epoll error</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">);</span>
	      <span style="font-weight: bold"><span style="color: #000000">close</span></span> <span style="color: #990000">(</span>events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>data<span style="color: #990000">.</span>fd<span style="color: #990000">);</span>
	      <span style="font-weight: bold"><span style="color: #0000FF">continue</span></span><span style="color: #990000">;</span>
	    <span style="color: #FF0000">}</span>

	  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sfd <span style="color: #990000">==</span> events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>data<span style="color: #990000">.</span>fd<span style="color: #990000">)</span>
	    <span style="color: #FF0000">{</span>
              <span style="font-style: italic"><span style="color: #9A1900">/* We have a notification on the listening socket, which</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                 means one or more incoming connections. */</span></span>
              <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
                <span style="color: #FF0000">{</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">sockaddr</span> in_addr<span style="color: #990000">;</span>
                  <span style="color: #008080">socklen_t</span> in_len<span style="color: #990000">;</span>
                  <span style="color: #009900">int</span> infd<span style="color: #990000">;</span>
                  <span style="color: #009900">char</span> hbuf<span style="color: #990000">[</span>NI_MAXHOST<span style="color: #990000">],</span> sbuf<span style="color: #990000">[</span>NI_MAXSERV<span style="color: #990000">];</span>

                  in_len <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span> in_addr<span style="color: #990000">;</span>
                  infd <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">accept</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>in_addr<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>in_len<span style="color: #990000">);</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>infd <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
                    <span style="color: #FF0000">{</span>
                      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((</span>errno <span style="color: #990000">==</span> EAGAIN<span style="color: #990000">)</span> <span style="color: #990000">||</span>
                          <span style="color: #990000">(</span>errno <span style="color: #990000">==</span> EWOULDBLOCK<span style="color: #990000">))</span>
                        <span style="color: #FF0000">{</span>
                          <span style="font-style: italic"><span style="color: #9A1900">/* We have processed all incoming</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                             connections. */</span></span>
                          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                        <span style="color: #FF0000">}</span>
                      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
                        <span style="color: #FF0000">{</span>
                          <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"accept"</span><span style="color: #990000">);</span>
                          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                        <span style="color: #FF0000">}</span>
                    <span style="color: #FF0000">}</span>

                  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">getnameinfo</span></span> <span style="color: #990000">(&amp;</span>in_addr<span style="color: #990000">,</span> in_len<span style="color: #990000">,</span>
                                   hbuf<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span> hbuf<span style="color: #990000">,</span>
                                   sbuf<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span> sbuf<span style="color: #990000">,</span>
                                   NI_NUMERICHOST <span style="color: #990000">|</span> NI_NUMERICSERV<span style="color: #990000">);</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
                    <span style="color: #FF0000">{</span>
                      <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Accepted connection on descriptor %d "</span>
                             <span style="color: #FF0000">"(host=%s, port=%s)</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> infd<span style="color: #990000">,</span> hbuf<span style="color: #990000">,</span> sbuf<span style="color: #990000">);</span>
                    <span style="color: #FF0000">}</span>

                  <span style="font-style: italic"><span style="color: #9A1900">/* Make the incoming socket non-blocking and add it to the</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                     list of fds to monitor. */</span></span>
                  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">make_socket_non_blocking</span></span> <span style="color: #990000">(</span>infd<span style="color: #990000">);</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
                    <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>

                  event<span style="color: #990000">.</span>data<span style="color: #990000">.</span>fd <span style="color: #990000">=</span> infd<span style="color: #990000">;</span>
                  event<span style="color: #990000">.</span>events <span style="color: #990000">=</span> EPOLLIN <span style="color: #990000">|</span> EPOLLET<span style="color: #990000">;</span>
                  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">epoll_ctl</span></span> <span style="color: #990000">(</span>efd<span style="color: #990000">,</span> EPOLL_CTL_ADD<span style="color: #990000">,</span> infd<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>event<span style="color: #990000">);</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
                    <span style="color: #FF0000">{</span>
                      <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"epoll_ctl"</span><span style="color: #990000">);</span>
                      <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
              <span style="font-weight: bold"><span style="color: #0000FF">continue</span></span><span style="color: #990000">;</span>
            <span style="color: #FF0000">}</span>
          <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
            <span style="color: #FF0000">{</span>
              <span style="font-style: italic"><span style="color: #9A1900">/* We have data on the fd waiting to be read. Read and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                 display it. We must read whatever data is available</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                 completely, as we are running in edge-triggered mode</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                 and won't get a notification again for the same</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                 data. */</span></span>
              <span style="color: #009900">int</span> done <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>

              <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
                <span style="color: #FF0000">{</span>
                  <span style="color: #008080">ssize_t</span> count<span style="color: #990000">;</span>
                  <span style="color: #009900">char</span> buf<span style="color: #990000">[</span><span style="color: #993399">512</span><span style="color: #990000">];</span>

                  count <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">read</span></span> <span style="color: #990000">(</span>events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>data<span style="color: #990000">.</span>fd<span style="color: #990000">,</span> buf<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span> buf<span style="color: #990000">);</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>count <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
                    <span style="color: #FF0000">{</span>
                      <span style="font-style: italic"><span style="color: #9A1900">/* If errno == EAGAIN, that means we have read all</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                         data. So go back to the main loop. */</span></span>
                      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>errno <span style="color: #990000">!=</span> EAGAIN<span style="color: #990000">)</span>
                        <span style="color: #FF0000">{</span>
                          <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"read"</span><span style="color: #990000">);</span>
                          done <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
                        <span style="color: #FF0000">}</span>
                      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                    <span style="color: #FF0000">}</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>count <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
                    <span style="color: #FF0000">{</span>
                      <span style="font-style: italic"><span style="color: #9A1900">/* End of file. The remote has closed the</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                         connection. */</span></span>
                      done <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
                      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                    <span style="color: #FF0000">}</span>

                  <span style="font-style: italic"><span style="color: #9A1900">/* Write the buffer to standard output */</span></span>
                  s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">write</span></span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,</span> buf<span style="color: #990000">,</span> count<span style="color: #990000">);</span>
                  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>s <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
                    <span style="color: #FF0000">{</span>
                      <span style="font-weight: bold"><span style="color: #000000">perror</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"write"</span><span style="color: #990000">);</span>
                      <span style="font-weight: bold"><span style="color: #000000">abort</span></span> <span style="color: #990000">();</span>
                    <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>

              <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>done<span style="color: #990000">)</span>
                <span style="color: #FF0000">{</span>
                  <span style="font-weight: bold"><span style="color: #000000">printf</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"Closed connection on descriptor %d</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span>
                          events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>data<span style="color: #990000">.</span>fd<span style="color: #990000">);</span>

                  <span style="font-style: italic"><span style="color: #9A1900">/* Closing the descriptor will make epoll remove it</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                     from the set of descriptors which are monitored. */</span></span>
                  <span style="font-weight: bold"><span style="color: #000000">close</span></span> <span style="color: #990000">(</span>events<span style="color: #990000">[</span>i<span style="color: #990000">].</span>data<span style="color: #990000">.</span>fd<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #000000">free</span></span> <span style="color: #990000">(</span>events<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">close</span></span> <span style="color: #990000">(</span>sfd<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> EXIT_SUCCESS<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>
</pre>


<p><strong>main</strong>() first
calls <strong>create_and_bind</strong>() which sets up the socket. It
then makes the socket non-blocking, and then
calls <strong>listen</strong>(2). It then creates an epoll instance
in <code>efd</code>, to which it adds the listening
socket <code>sfd</code> to watch for input events in an edge-triggered
mode.</p>

<p>The outer while loop is the main events loop. It
calls <strong>epoll_wait</strong>(2), where the thread remains blocked
waiting for events. When events are
available, <strong>epoll_wait</strong>(2) returns the events in
the <code>events</code> argument, which is a bunch
of <code>epoll_event</code> structures.</p>

<p>The epoll instance in <code>efd</code> is continuously updated in the
event loop when we add new incoming connections to watch, and remove
existing connections when they die.</p>

<p>When events are available, they can be of three types:</p>

<ul>

<li><strong>Errors:</strong> When an error condition occurs, or the
event is not a notification about data available for reading, we simply
close the associated descriptor. Closing the descriptor automatically
removes it from the watched set of epoll instance <code>efd</code>.</li>

<li><strong>New connections:</strong> When the listening
descriptor <code>sfd</code> is ready for reading, it means one or more
new connections have arrived. While there are new
connections, <strong>accept</strong>(2) the connections, print a message
about it, make the incoming socket non-blocking and add it to the
watched set of epoll instance <code>efd</code>.</li>

<li><strong>Client data:</strong> When data is available for reading on
any of the client descriptors, we use <strong>read</strong>(2) to read
the data in pieces of 512 bytes in an inner while loop. This is because
we have to read all the data that is available now, as we won't get
further events about it as the descriptor is watched in edge-triggered
mode. The data which is read is written to stdout (fd=1)
using <strong>write</strong>(2).  If <strong>read</strong>(2) returns 0,
it means an EOF and we can close the client's connection. If -1 is
returned, and
<code>errno</code> is set to <code>EAGAIN</code>, it means that all data
for this event was read, and we can go back to the main loop.</li>

</ul>

<p>That's that. It goes around and around in a loop, adding and removing
descriptors in the watched set.</p>

<p>Download the <a rel="nofollow"
href="/blog/2/how-to-use-epoll-a-complete-example-in-c/epoll-example.c"><strong>epoll-example.c</strong></a>
program.</p>

<p><strong>Update1:</strong> Level and edge triggered definitions were
erroneously reversed (though the code was correct). It was noticed by
Reddit user <a rel="nofollow"
href="http://www.reddit.com/user/bodski">bodski</a>. The article has
been corrected now. I should have proof-read it before
posting. Apologies, and thank you for pointing out the mistake. :)</p>

<p><strong>Update2:</strong> The code has been modified to run
<strong>accept</strong>(2) until it says it would block, so that if
multiple connections have arrived, we accept all of them.  It was
noticed by Reddit user <a rel="nofollow"
href="http://www.reddit.com/user/cpitchford">cpitchford</a>. Thank you
for the comments. :)</p>

<div class="social-buttons">
<p>
<a target="facebook6c7af8d8615c0d986040c80840d5a740" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Fbanu.com%2Fblog%2F2%2Fhow-to-use-epoll-a-complete-example-in-c%2F" title="Recommend on Facebook"><img src="https://banu.com/static/0.9.53/images/social-buttons/facebook.png" width="95" height="30" alt="Recommend on Facebook" /></a>
<a target="twitter6c7af8d8615c0d986040c80840d5a740" href="http://twitter.com/home?status=https%3A%2F%2Fbanu.com%2Fblog%2F2%2Fhow-to-use-epoll-a-complete-example-in-c%2F" title="Tweet this"><img src="https://banu.com/static/0.9.53/images/social-buttons/twitter.png" width="83" height="30" alt="Tweet this" /></a>
<a target="reddit6c7af8d8615c0d986040c80840d5a740" href="http://www.reddit.com/submit?url=https%3A%2F%2Fbanu.com%2Fblog%2F2%2Fhow-to-use-epoll-a-complete-example-in-c%2F" title="Submit to Reddit"><img src="https://banu.com/static/0.9.53/images/social-buttons/reddit.png" width="132" height="30" alt="Submit to Reddit" /></a>
</p>
</div>


</div> <!-- banu-twocol-main -->

</div> <!-- banu-simple-page -->

<div id="catcher"></div>

</div> <!-- banu-page -->

<div id="banu-footer">
<p>Copyright &copy; 2011 Banu Systems Private Limited, India.</p>
<p>
<a rel="nofollow" href="/about/">About Banu</a>
&middot; <a rel="nofollow" href="/security/">Security</a>
&middot; <a rel="nofollow" href="/accessibility/">Accessibility</a>
&middot; <a rel="nofollow" href="/privacy/">Privacy</a>
&middot; <a rel="nofollow" href="/credits/">Credits</a>
&middot; <a rel="nofollow" href="/mailman/listinfo">Mailing lists</a>
&middot; <a rel="nofollow" href="/cgit/">Git</a>
&middot; <a rel="nofollow" href="/bugzilla/">Bugzilla</a>
&middot; <a rel="nofollow" href="/forums/">Forums</a>
</p>

</div> <!-- banu-footer -->

<!--
    Generated on: November 7, 2011 at 02:36 UTC
    User-Agent: Wget/1.12 (linux-gnu)
    Document creation time: 9 ms
    SQL query count: 3
-->
<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://banu.com/piwik/" : "http://banu.com/piwik/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<!-- End Piwik -->

</body>
</html>
